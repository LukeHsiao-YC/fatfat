<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ•ˆç‡ƒè„‚å››éƒ¨æ›²ï¼šæŒ‘æˆ°ç´€éŒ„ç‰ˆV10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-card { border: 2px solid #ef4444; transform: scale(1.02); }
        .completed-card { opacity: 0.6; background-color: #f9fafb; border-color: #d1d5db; }
        button { touch-action: manipulation; }
        
        .exercise-image-container {
            width: 100%;
            height: 240px; 
            background-color: #ffffff;
            background-size: contain; 
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .upload-overlay {
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .exercise-image-container:hover .upload-overlay {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-32">

    <!-- Data Islands -->
    <script id="offline-data-custom" type="application/json">{}</script>

    <header class="fixed top-0 w-full bg-white shadow-md z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-bold text-gray-800">å°‹æ‰¾è…¹è‚Œå¤§æŒ‘æˆ°</h1>
                <p class="text-xs text-gray-500">ç›®æ¨™ï¼šæ¯æ—¥ 6 çµ„      è•­å®‡è¶…è£½ä½œ </p>
            </div>
            <div class="flex flex-col items-end">
                <div id="mainTimer" class="text-3xl font-mono font-black text-gray-800 leading-none">00:00</div>
                <div id="statusText" class="text-xs font-bold text-gray-400 uppercase">æº–å‚™å°±ç·’</div>
            </div>
        </div>
        <div class="w-full bg-gray-200 h-1">
            <div id="progressBar" class="bg-red-500 h-1 w-0 transition-all duration-1000"></div>
        </div>
    </header>

    <div class="h-24"></div>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- Info Section -->
        <section class="bg-white rounded-xl shadow p-4 border border-gray-100">
            <!-- æˆåŠŸå¤©æ•¸çµ±è¨ˆ -->
            <div class="flex items-center justify-between mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ”¥</span>
                    <div>
                        <div class="text-xs text-orange-600 font-bold uppercase">ç´¯ç©æŒ‘æˆ°æˆåŠŸ</div>
                        <div class="text-sm text-orange-800">ç›®æ¨™é”æˆ (>6çµ„)</div>
                    </div>
                </div>
                <div class="text-2xl font-black text-orange-600">
                    <span id="successDays">0</span> <span class="text-sm font-normal text-orange-500">å¤©</span>
                </div>
            </div>

            <h3 class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">æ™‚é–“è¨­å®š (ç§’)</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">æ¯å€‹å‹•ä½œ (é‹å‹•)</label>
                    <input type="number" id="workDuration" value="45" class="w-full text-center border-2 border-red-100 rounded-lg py-2 text-xl font-bold text-red-600 focus:border-red-500 focus:outline-none" onchange="saveSettings()">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">å‹•ä½œé–“éš” (ä¼‘æ¯)</label>
                    <input type="number" id="restDuration" value="30" class="w-full text-center border-2 border-green-100 rounded-lg py-2 text-xl font-bold text-green-600 focus:border-green-500 focus:outline-none" onchange="saveSettings()">
                </div>
            </div>
        </section>

        <div id="cardsContainer" class="space-y-4"></div>

        <!-- Bottom Control Bar -->
        <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 pb-8 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <!-- ä»Šæ—¥çµ„æ•¸é¡¯ç¤º -->
                <div>
                    <div class="text-xs text-gray-500">ä»Šæ—¥å®Œæˆçµ„æ•¸</div>
                    <div class="flex items-baseline">
                        <span id="completedGroups" class="text-3xl font-black text-red-600">0</span>
                        <span class="text-sm text-gray-400 ml-1">/ 6</span>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ•å€ -->
                <div class="flex gap-2">
                     <button onclick="resetDailyProgress()" class="bg-gray-100 text-gray-500 hover:bg-gray-200 px-3 py-2 rounded-lg font-bold text-xs active:scale-95 transition flex items-center gap-1">
                        <span>â†º</span> é‡ç½®ä»Šæ—¥
                     </button>
                     <button onclick="stopTimer()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold text-sm active:scale-95 transition shadow-lg hover:bg-gray-700">
                        â¹ åœæ­¢è¨ˆæ™‚
                     </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- V9 Updated SVG Library ---
        const svgLibrary = {
            clap: `
                <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#dbeafe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="300" height="300" fill="url(#grad1)"/>
                    <ellipse cx="150" cy="270" rx="70" ry="10" fill="#93c5fd" opacity="0.5"/>
                    <path d="M130,150 L130,220 L120,270 L150,270 L150,220 L150,150" fill="#1e3a8a"/>
                    <path d="M135,75 L130,140 Q130,190 170,195" fill="none" stroke="#b45309" stroke-width="14" stroke-linecap="round"/>
                    <path d="M125,70 L155,70 L150,160 L130,160 Z" fill="#2563eb"/>
                    <circle cx="140" cy="55" r="22" fill="#fcd34d"/>
                    <path d="M150,150 L210,150 L210,210" fill="none" stroke="#3b82f6" stroke-width="24" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M145,75 L155,130 Q160,190 180,195" fill="none" stroke="#fcd34d" stroke-width="14" stroke-linecap="round"/>
                    <circle cx="175" cy="195" r="10" fill="#ef4444" opacity="0.8"/>
                    <path d="M165,185 L185,205 M185,185 L165,205" stroke="#ffffff" stroke-width="2"/>
                    <path d="M230,190 Q240,170 230,150" fill="none" stroke="#ef4444" stroke-width="4" marker-end="url(#arrow)"/>
                </svg>`,
            sideKnee: `
                <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad2" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#e0e7ff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="300" height="300" fill="url(#grad2)"/>
                    <ellipse cx="150" cy="270" rx="70" ry="10" fill="#a5b4fc" opacity="0.5"/>
                    <path d="M135,160 L135,270" stroke="#3730a3" stroke-width="24" stroke-linecap="round"/>
                    <path d="M165,160 L220,140 L220,200" fill="none" stroke="#4f46e5" stroke-width="24" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M135,160 Q135,100 180,90" fill="none" stroke="#6366f1" stroke-width="45" stroke-linecap="round"/>
                    <circle cx="185" cy="70" r="22" fill="#fcd34d"/>
                    <path d="M160,85 L130,70 L165,55" fill="none" stroke="#fbbf24" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M190,85 L230,90 L205,55" fill="none" stroke="#fbbf24" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M210,110 L220,125" stroke="#ef4444" stroke-width="4"/>
                    <path d="M215,105 L225,120" stroke="#ef4444" stroke-width="4"/>
                </svg>`,
            press: `
                <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad3" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#f3e8ff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="300" height="300" fill="url(#grad3)"/>
                    <ellipse cx="150" cy="270" rx="70" ry="10" fill="#c4b5fd" opacity="0.5"/>
                    <path d="M140,150 L135,270" stroke="#6b21a8" stroke-width="24" stroke-linecap="round"/>
                    <path d="M160,150 L200,130 L200,220" fill="none" stroke="#7e22ce" stroke-width="24" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M150,160 L150,70" stroke="#9333ea" stroke-width="45" stroke-linecap="round"/>
                    <circle cx="150" cy="50" r="22" fill="#fcd34d"/>
                    <path d="M130,60 L180,110" stroke="#fcd34d" stroke-width="18" stroke-linecap="round"/>
                    <path d="M170,60 L200,110" stroke="#fcd34d" stroke-width="18" stroke-linecap="round"/>
                    <path d="M190,70 L190,100" stroke="#ef4444" stroke-width="4" stroke-dasharray="5,5"/>
                </svg>`,
            jump: `
                <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad4" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#fee2e2;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="300" height="300" fill="url(#grad4)"/>
                    <ellipse cx="150" cy="280" rx="50" ry="6" fill="#fca5a5" opacity="0.4"/>
                    <path d="M150,150 L110,260" stroke="#991b1b" stroke-width="24" stroke-linecap="round"/>
                    <path d="M150,150 L190,260" stroke="#991b1b" stroke-width="24" stroke-linecap="round"/>
                    <path d="M150,160 L150,70" stroke="#b91c1c" stroke-width="45" stroke-linecap="round"/>
                    <circle cx="150" cy="50" r="22" fill="#fcd34d"/>
                    <path d="M130,75 L90,30" stroke="#fcd34d" stroke-width="18" stroke-linecap="round"/>
                    <path d="M170,75 L210,30" stroke="#fcd34d" stroke-width="18" stroke-linecap="round"/>
                    <path d="M70,200 Q50,170 70,140" fill="none" stroke="#fbbf24" stroke-width="4" stroke-dasharray="4,4"/>
                    <path d="M230,200 Q250,170 230,140" fill="none" stroke="#fbbf24" stroke-width="4" stroke-dasharray="4,4"/>
                </svg>`
        };

        const exercises = [
            { id: 1, name: "èƒ¯ä¸‹æ“ŠæŒ", en: "Under-Leg Clap", desc: "èƒŒéƒ¨æŒºç›´ï¼Œå¤§è…¿æŠ¬é«˜ï¼Œå·¦å³äº¤æ›¿ã€‚", color: "blue", svgKey: "clap" },
            { id: 2, name: "åŒå´æè†", en: "Side Knee Drive", desc: "å³è…¿å‘å³å´ä¸Šæ–¹æè†ï¼ŒåŒæ™‚å´è…¹ç™¼åŠ›ï¼Œå³æ‰‹è‚˜å¸¶å‹•èº«é«”å¾€å³å½é è¿‘å³è†è“‹ï¼Œå·¦å³äº¤æ›¿ã€‚", color: "indigo", svgKey: "sideKnee" },
            { id: 3, name: "æè†ä¸‹å£“", en: "Knee Drive Press", desc: "é›™è…³èˆ‡è‚©åŒå¯¬ï¼Œé›™æ‰‹äº’æ¡èˆ‰é«˜ï¼Œæ ¸å¿ƒæ”¶ç·Šï¼Œæ¥è‘—å°‡è†è“‹é«˜é«˜æŠ¬å‘èƒ¸å£ï¼ŒåŒæ™‚é›™æ‰‹äº’æ¡å‘ä¸‹æ‹‰ç¢°åˆ°è†è“‹ï¼Œå·¦å³äº¤æ›¿ã€‚", color: "purple", svgKey: "press" },
            { id: 4, name: "é–‹åˆè·³", en: "Jumping Jacks", desc: "é›™è…³é–‹åˆï¼Œè½åœ°è¼•ç›ˆï¼Œè‹¥è†è“‹ç–¼ç—›å¯ä»¥æ”¹ç‚ºé–‹åˆå´è¸æ­¥ã€‚", color: "red", svgKey: "jump" }
        ];

        let timerInterval = null;
        let currentState = 'IDLE'; 
        let currentStepIndex = 0;
        let timeLeft = 0;
        let totalTime = 0;
        let customImages = {}; 

        function init() {
            try {
                const customData = document.getElementById('offline-data-custom').textContent;
                if(customData && customData.trim() !== '{}') customImages = JSON.parse(customData);
            } catch(e) {}
            
            checkDateAndReset();
            renderCards();
            updateDailyProgress();
            updateSuccessfulDaysDisplay();
        }
        
        // --- Date Checking Logic ---
        function checkDateAndReset() {
            const lastDate = localStorage.getItem('lastActiveDate');
            const today = new Date().toISOString().split('T')[0];
            
            // å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œè‡ªå‹•é‡ç½®ä»Šæ—¥çµ„æ•¸
            if (lastDate !== today) {
                localStorage.setItem('groupsDone_v2', 0);
                localStorage.setItem('lastActiveDate', today);
            }
        }

        function getSvgDataUrl(svgString) {
            return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgString)));
        }

        function handleSingleImageUpload(index, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customImages[index] = e.target.result;
                    renderCards(); 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            exercises.forEach((ex, index) => {
                let bgStyle;
                
                if (customImages[index]) {
                    bgStyle = `background-image: url('${customImages[index]}'); background-size: cover;`;
                } else {
                    bgStyle = `background-image: url('${getSvgDataUrl(svgLibrary[ex.svgKey])}');`;
                }
                
                const html = `
                    <div id="card-${index}" class="bg-white rounded-xl shadow p-5 transition-all duration-300 border-l-4 border-${ex.color}-500 relative overflow-hidden">
                        <div class="flex justify-between items-start relative z-10 mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${index + 1}. ${ex.name}</h3>
                                <p class="text-xs text-gray-500 font-medium">${ex.en}</p>
                            </div>
                            <span class="bg-${ex.color}-100 text-${ex.color}-800 text-xs px-2 py-1 rounded font-bold">30 ä¸‹</span>
                        </div>
                        <label class="block relative z-10 w-full mb-3 cursor-pointer group">
                             <div class="exercise-image-container" style="${bgStyle}">
                                <div class="upload-overlay absolute inset-0 flex items-center justify-center text-white font-bold text-sm backdrop-blur-sm rounded-lg">
                                    ğŸ“· è‡ªè¨‚åœ–ç‰‡
                                </div>
                             </div>
                             <input type="file" class="hidden" accept="image/*" onchange="handleSingleImageUpload(${index}, this)">
                        </label>
                        <p class="text-sm text-gray-600 mt-2 mb-4 leading-relaxed relative z-10">${ex.desc}</p>
                        <div class="flex gap-2 relative z-10">
                            <button id="btn-${index}" onclick="startWork(${index})" 
                                class="flex-1 bg-${ex.color}-500 hover:bg-${ex.color}-600 text-white py-3 rounded-lg font-bold text-lg shadow active:scale-95 transition-transform flex items-center justify-center gap-2">
                                é–‹å§‹
                            </button>
                        </div>
                        <div id="progress-bg-${index}" class="absolute bottom-0 left-0 h-1 bg-${ex.color}-200 w-0 transition-all duration-1000"></div>
                    </div>
                `;
                container.innerHTML += html;
            });
            if (currentState !== 'IDLE') {
                document.getElementById(`card-${currentStepIndex}`).classList.add('active-card');
            }
        }

        function clearGlobalTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }

        function stopTimer() {
            clearGlobalTimer();
            currentState = 'IDLE';
            updateTimerDisplay(0, 0); 
            document.getElementById('statusText').innerText = "å·²æš«åœ";
            document.getElementById('statusText').className = "text-xs font-bold text-gray-400 uppercase";
            document.querySelectorAll('[id^="card-"]').forEach(el => {
                el.classList.remove('active-card', 'ring-2', 'ring-offset-2');
                el.style.opacity = '1';
            });
        }
        
        // --- New Function: Reset Daily Progress ---
        function resetDailyProgress() {
            if (confirm("ç¢ºå®šè¦å°‡ã€Œä»Šæ—¥å®Œæˆçµ„æ•¸ã€æ­¸é›¶å—ï¼Ÿ\n(é€™ä¸æœƒå½±éŸ¿å·²ç´¯ç©çš„æˆåŠŸå¤©æ•¸)")) {
                localStorage.setItem('groupsDone_v2', 0);
                updateDailyProgress();
            }
        }

        function startWork(index) {
            clearGlobalTimer();
            document.querySelectorAll('[id^="card-"]').forEach(el => {
                el.classList.remove('active-card', 'ring-2', 'ring-offset-2');
            });
            currentStepIndex = index;
            document.getElementById(`card-${index}`).classList.add('active-card');
            currentState = 'WORK';
            timeLeft = parseInt(document.getElementById('workDuration').value);
            totalTime = timeLeft;
            updateStatusText(`å‹•ä½œ ${index + 1} é€²è¡Œä¸­`, 'text-red-600');
            const btn = document.getElementById(`btn-${index}`);
            if(btn) {
                btn.innerHTML = `<span class="animate-pulse">è¨ˆæ™‚ä¸­...</span>`;
                btn.disabled = true;
            }
            tick(); 
            timerInterval = setInterval(tick, 1000);
        }

        function startRest(index) {
            clearGlobalTimer();
            const prevCard = document.getElementById(`card-${index}`);
            prevCard.classList.remove('active-card');
            prevCard.classList.add('completed-card');
            const prevBtn = document.getElementById(`btn-${index}`);
            if(prevBtn) {
                prevBtn.innerText = "âœ“ å®Œæˆ";
                prevBtn.className = "flex-1 bg-gray-300 text-gray-500 py-3 rounded-lg font-bold text-lg cursor-not-allowed";
            }
            if (index >= exercises.length - 1) {
                finishGroup();
                return;
            }
            currentState = 'REST';
            timeLeft = parseInt(document.getElementById('restDuration').value);
            totalTime = timeLeft;
            document.getElementById(`card-${index+1}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateStatusText('ä¼‘æ¯æ™‚é–“', 'text-green-600');
            timerInterval = setInterval(tick, 1000);
        }

        function tick() {
            updateTimerDisplay(timeLeft, totalTime);
            if (timeLeft <= 0) {
                clearGlobalTimer();
                playBeep(); 
                if (currentState === 'WORK') {
                    startRest(currentStepIndex);
                } else if (currentState === 'REST') {
                    const nextIndex = currentStepIndex + 1;
                    if (nextIndex < exercises.length) {
                         startWork(nextIndex); 
                    }
                }
            }
            timeLeft--;
        }

        function updateTimerDisplay(current, total) {
            const mins = Math.floor(current / 60).toString().padStart(2, '0');
            const secs = (current % 60).toString().padStart(2, '0');
            document.getElementById('mainTimer').innerText = `${mins}:${secs}`;
            const percent = total > 0 ? ((total - current) / total) * 100 : 0;
            const bar = document.getElementById('progressBar');
            bar.style.width = `${percent}%`;
            if (currentState === 'WORK') {
                document.getElementById('mainTimer').classList.replace('text-green-600', 'text-red-600');
                bar.className = `h-1 transition-all duration-1000 bg-red-500`;
            } else if (currentState === 'REST') {
                document.getElementById('mainTimer').classList.replace('text-red-600', 'text-green-600');
                bar.className = `h-1 transition-all duration-1000 bg-green-500`;
            }
        }

        function updateStatusText(text, colorClass) {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.className = `text-xs font-bold uppercase ${colorClass}`;
        }
        
        function finishGroup() {
            updateStatusText('å›åˆçµæŸï¼', 'text-blue-600');
            document.getElementById('mainTimer').innerText = "å®Œæˆ";
            let done = parseInt(localStorage.getItem('groupsDone_v2')) || 0;
            done++;
            localStorage.setItem('groupsDone_v2', done);
            
            // è¨˜éŒ„æŒ‘æˆ°ç´€éŒ„
            updateHistory(done);
            
            updateDailyProgress();
            alert("å¤ªæ£’äº†ï¼æ‚¨å·²å®Œæˆé€™ä¸€çµ„å¾ªç’°ï¼");
            setTimeout(() => {
                renderCards(); 
                stopTimer();
            }, 1000);
        }
        
        // --- History & Stats Logic ---
        function updateHistory(todayGroups) {
            const today = new Date().toISOString().split('T')[0];
            let history = JSON.parse(localStorage.getItem('challengeHistory') || '{}');
            
            // æ›´æ–°ä»Šå¤©çš„çµ„æ•¸
            history[today] = todayGroups;
            localStorage.setItem('challengeHistory', JSON.stringify(history));
            
            updateSuccessfulDaysDisplay();
        }
        
        function updateSuccessfulDaysDisplay() {
            const history = JSON.parse(localStorage.getItem('challengeHistory') || '{}');
            // è¨ˆç®—çµ„æ•¸ >= 6 çš„å¤©æ•¸
            const successCount = Object.values(history).filter(count => count >= 6).length;
            document.getElementById('successDays').innerText = successCount;
        }

        function updateDailyProgress() {
            const done = parseInt(localStorage.getItem('groupsDone_v2')) || 0;
            document.getElementById('completedGroups').innerText = done;
        }

        function saveSettings() {}

        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) {}
        }

        init();
    </script>
</body>

</html>
